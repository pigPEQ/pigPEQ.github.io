<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Js引擎级别的执行 - MSpace</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="MSpace"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/pigPEQ/pigPEQ.github.io/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="MSpace"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="js是一门单线程的脚本语言，但是可以利用单线程去模拟多线程机制，当前最流行的是Chrome的v8引擎，该引擎主要由两部分组成内存堆（Memory Heap）和调用栈（Call Stack）组成。其中，Memory Heap分配内存的区域，Call Stack负责代码执行区域。"><meta property="og:type" content="blog"><meta property="og:title" content="Js引擎级别的执行"><meta property="og:url" content="https://pigpeq.github.io/2019/e7a52f913357/"><meta property="og:site_name" content="MSpace"><meta property="og:description" content="js是一门单线程的脚本语言，但是可以利用单线程去模拟多线程机制，当前最流行的是Chrome的v8引擎，该引擎主要由两部分组成内存堆（Memory Heap）和调用栈（Call Stack）组成。其中，Memory Heap分配内存的区域，Call Stack负责代码执行区域。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://chenspace.oss-cn-shanghai.aliyuncs.com/uPic/wallroom-1920x1440-bg-8e6b465.png"><meta property="article:published_time" content="2019-06-03T12:45:26.000Z"><meta property="article:modified_time" content="2022-01-29T12:25:28.470Z"><meta property="article:author" content="ChenL"><meta property="article:tag" content="Js"><meta property="article:tag" content="v8"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://chenspace.oss-cn-shanghai.aliyuncs.com/uPic/wallroom-1920x1440-bg-8e6b465.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://pigpeq.github.io/2019/e7a52f913357/"},"headline":"MSpace","image":["https://chenspace.oss-cn-shanghai.aliyuncs.com/uPic/wallroom-1920x1440-bg-8e6b465.png"],"datePublished":"2019-06-03T12:45:26.000Z","dateModified":"2022-01-29T12:25:28.470Z","author":{"@type":"Person","name":"ChenL"},"description":"js是一门单线程的脚本语言，但是可以利用单线程去模拟多线程机制，当前最流行的是Chrome的v8引擎，该引擎主要由两部分组成内存堆（Memory Heap）和调用栈（Call Stack）组成。其中，Memory Heap分配内存的区域，Call Stack负责代码执行区域。"}</script><link rel="canonical" href="https://pigpeq.github.io/2019/e7a52f913357/"><link rel="icon" href="https://cdn.jsdelivr.net/gh/pigPEQ/pigPEQ.github.io/img/favicon.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/tomorrow.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/pigPEQ/pigPEQ.github.io/css/default.min.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="MSpace" type="application/atom+xml">
</head><body class="is-3-column"><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/pigPEQ/pigPEQ.github.io/js/dark.min.js"></script><canvas id="universe"></canvas><nav class="navbar navbar-main"><div class="container"><div class="navbar-menu"><a class="navbar-item navbar-logo" href="/"><img class="logo-img" src="/img/logo-light.png" alt="MSpace" height="32"><img class="logo-img-dark" src="/img/logo-night.png" alt="MSpace" height="32"></a><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/message">留言</a><a class="navbar-item" href="/friend">友链</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_target" rel="noopener" title="网盘" href="https://www.aliyundrive.com/s/hYKSWcxqF6Z/folder/61f75f557d2b6757bfec4aabb41763ba3cc4e448"><i class="fas fa-cloud-download-alt"></i></a><a class="navbar-item dark" id="dark-nav" title="Dark Mode" href="javascript:;"><i class="fas fa-moon" id="dark-icon"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="controller"></div><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="https://chenspace.oss-cn-shanghai.aliyuncs.com/uPic/wallroom-1920x1440-bg-8e6b465.png" alt="Js引擎级别的执行"><img class="fill_dark" src="https://chenspace.oss-cn-shanghai.aliyuncs.com/uPic/wallroom-1920x1440-bg-8e6b465.png" alt="Js引擎级别的执行"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item create-data"><i class="far fa-calendar-alt">&nbsp;&nbsp;</i><time dateTime="2019-06-03T12:45:26.000Z" title="2019-06-03T12:45:26.000Z">2019-06-03</time>发表</span><span class="level-item cate"><i class="far fa-folder-open">  </i><a class="link-muted" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BC%96%E7%A8%8B/">计算机编程</a></span><span class="level-item read-time"><i class="far fa-clock">  </i>19 分钟读完 (大约 2922 个字)</span><span class="level-item leancloud_visitors" id="/2019/e7a52f913357/" data-flag-title="Js引擎级别的执行"><i class="far fa-eye"></i>&nbsp;&nbsp;<span id="twikoo_visitors"><i class="fa fa-spinner fa-spin"></i></span> 次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Js引擎级别的执行</h1><div class="content"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><blockquote>
<p>js是一门单线程的脚本语言，但是可以利用单线程去模拟多线程机制，当前最流行的是Chrome的v8引擎，该引擎主要由两部分组成内存堆（Memory Heap）和调用栈（Call Stack）组成。其中，Memory Heap分配内存的区域，Call Stack负责代码执行区域。</p>
</blockquote>
<span id="more"></span>

<h3 id="执行上下文"><a href="#执行上下文" class="headerlink" title="执行上下文"></a>执行上下文</h3><p>执行上下文是评估和执行 js代码的环境的抽象概念，js代码都是在执行上下文中运行的。具体包括三种类型的执行上下文：全局执行上下文、函数执行上下文以及eval执行上下文。</p>
<h4 id="上下文的分类"><a href="#上下文的分类" class="headerlink" title="上下文的分类"></a>上下文的分类</h4><p>全局执行上下文，即任何不在函数中的代码都是全局执行上下文，并且一个程序中只有一个全局执行上下文。它会执行两个事件：1.创建全局的<code>window</code>对象；2.实现<code>this</code>绑定这个全局对象。</p>
<p>函数执行上下文，即每个函数被调用时都会创建一个函数上下文，函数上下文可以有多个。</p>
<p><code>eval</code>执行上下文，即执行<code>eval</code>函数内部的代码也会有它属于自己的执行上下文。</p>
<h4 id="上下文的创建"><a href="#上下文的创建" class="headerlink" title="上下文的创建"></a>上下文的创建</h4><p>在js代码执行之前，执行上下文将经历创建阶段，创建阶段包括以下三个步骤：</p>
<p>1.<code>This</code>绑定</p>
<p>在全局执行上下文中，<code>this</code>的值指向全局对象；在函数执行上下文中，<code>this</code>的值指向调用函数的对象，如果没有该函数调用的对象，那么<code>this</code>的值将指向全局对象或者<code>undefined</code>（严格模式下）。</p>
<p>2.词法环境</p>
<p>词法环境是一种持有标识符-变量映射的结构。其内部有两个组件：环境记录器和外部环境的引用。环境记录器用来记录变量和函数的具体位置；外部环境引用意味着作用域。</p>
<p>3.变量环境</p>
<p>变量环境同样也是以一种词法环境，其环境记录器持有变量声明语句在执行上下文中创建的绑定关系。</p>
<p>在 <code>ES6</code> 中，词法环境组件和变量环境的一个不同就是前者被用来存储函数声明和变量（<code>let</code> 和 <code>const</code>）绑定，而后者只用来存储 <code>var</code> 变量绑定。</p>
<h3 id="调用栈"><a href="#调用栈" class="headerlink" title="调用栈"></a>调用栈</h3><p>调用栈是一种后进先出的数据结构，又称为执行栈，是用来追踪函数执行流的一种机制，当执行环境中调用了多个函数时，通过这种机制，我们能够追踪到哪个函数正在执行，执行的函数体中又调用了哪个函数。</p>
<ul>
<li>每调用一个函数，解释器就会把该函数添加进调用栈并开始执行。</li>
<li>正在调用栈中执行的函数还调用了其它函数，那么新函数也将会被添加进调用栈，一旦这个函数被调用，便会立即执行。</li>
<li>当前函数执行完毕后，解释器将其清出调用栈，继续执行当前执行环境下的剩余的代码。</li>
<li>当分配的调用栈空间被占满时，会引发“堆栈溢出”。</li>
</ul>
<figure class="highlight js"><figcaption><span>点击展开代码 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="string">&#x27;hello everybody&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">first</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;this is first&#x27;</span>);</span><br><span class="line">  second();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;this is first again&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">second</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;this is second&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">first();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;today is Friday&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>当程序开始执行的时候，调用栈是空的，然后，步骤如下，其中每一个进入调用栈的都称为“调用帧”：<br><img src="https://chenspace.oss-cn-shanghai.aliyuncs.com/uPic/%E8%B0%83%E7%94%A8%E6%A0%88.png" alt="调用栈"></p>
<p>当上述代码在浏览器加载时，<code>JavaScript</code> 引擎创建了一个全局执行上下文并把它压入当前执行栈。当遇到 <code>first()</code> 函数调用时，<code>JavaScript</code> 引擎为该函数创建一个新的执行上下文并把它压入当前执行栈的顶部。</p>
<p>当从 <code>first()</code> 函数内部调用 <code>second()</code> 函数时，<code>JavaScript</code> 引擎为 <code>second()</code> 函数创建了一个新的执行上下文并把它压入当前执行栈的顶部。当 <code>second()</code> 函数执行完毕，它的执行上下文会从当前栈弹出，并且控制流程到达下一个执行上下文，即 <code>first()</code> 函数的执行上下文。</p>
<p>当 <code>first()</code> 执行完毕，它的执行上下文从栈弹出，控制流程到达全局执行上下文。一旦所有代码执行完毕，<code>JavaScript</code> 引擎从当前栈中移除全局执行上下文。</p>
<p>堆栈溢出：当你达到调用栈最大的大小的时候就会发生这种情况，而且这相当容易发生，特别是在你写递归的时候却没有全方位的测试它。</p>
<h3 id="事件循环"><a href="#事件循环" class="headerlink" title="事件循环"></a>事件循环</h3><p>由于js是单线程语言，所以一个个任务的执行需要排队，就像银行的窗口一样，一个客户办完一个业务才能轮到下一个客户去办理业务，如果前一个用户办理用时过长，那么后一个用户必须等待。下面用一个流程图清晰展示事件执行的机制，在此之前，我们将事件分为两类：同步任务和异步任务。在执行栈中，同步任务总是优先执行。</p>
<p> <img src="https://chenspace.oss-cn-shanghai.aliyuncs.com/uPic/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF.png" alt="事件循环"></p>
<ul>
<li>同步和异步任务分别进入不同的执行”场所”，同步的进入主线程，异步的进<code>Event Table</code>并注册函数。</li>
<li>当指定的事情完成时，<code>Event Table</code>会将这个函数移入<code>Event Queue</code>。</li>
<li>主线程内的任务执行完毕为空，会去<code>Event Queue</code>读取对应的函数，进入主线程执行。</li>
<li>上述过程会不断重复，也就是常说的<code>Event Loop</code>(事件循环)。</li>
</ul>
<p>那么如何知道主线程中是否为空呢？在v8引擎中存在一个<code>monitoring process</code>进程，会持续不断的检查主线程执行栈是否为空，一旦为空，就会去<code>Event Queue</code>那里检查是否有等待被调用的函数。</p>
<h5 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h5><ul>
<li><strong>Ajax</strong></li>
</ul>
<figure class="highlight js"><figcaption><span>点击展开代码 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> data=data;</span><br><span class="line">$.ajax(&#123;</span><br><span class="line">    <span class="attr">url</span>:www.sdhsab.com;</span><br><span class="line">    data:data;</span><br><span class="line">    success:<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;发送成功&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;代码执行结束&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>上述是一段简易的<code>ajax</code>请求，其中：</p>
<ol>
<li><code>ajax</code>进入<code>Event Table</code>中，注册回调函数<code>success</code>；</li>
<li>注册完后进入<code>Event Queue</code>中，等待执行；</li>
<li>执行<code>console.log(&#39;代码执行结束&#39;);</code></li>
<li>主线程从<code>Event Queue</code>中读取回调<code>success</code>执行</li>
</ol>
<ul>
<li><strong>setTimeOut</strong></li>
</ul>
<figure class="highlight js"><figcaption><span>点击展开代码 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setTimeOut(<span class="function">()=&gt;</span>&#123;<span class="keyword">new</span>()&#125;,<span class="number">1000</span>);</span><br><span class="line">sleep(<span class="number">100000</span>)</span><br></pre></td></tr></table></figure>

<p>上述代码是怎么运行的：</p>
<ol>
<li><code>new()</code>进入<code>Event table</code>并注册，开始计时；</li>
<li>执行<code>sleep()</code>函数，计时仍在继续；</li>
<li>计时时间到，计时事件<code>setTimeout</code>完成，但是<code>sleep()</code>函数仍在执行，只能继续等待；</li>
<li><code>sleep()</code>终于执行结束，<code>new()</code>进入主线程执行。</li>
</ol>
<ul>
<li><strong>setinterval</strong></li>
</ul>
<p><code>setInterval</code>与<code>setTimeOut</code>类似，区别点在于<code>setInterval</code>在注册函数之后会指定时间间隔不断地将函数注入到<code>Event  Queue</code>中。一旦<code>setInterval</code>的回调函数<code>fn</code>执行时间超过了延迟时间，那么就完全看不出来有时间间隔了。</p>
<p>我们经常还会遇到<code>setOutTime(Fn,0)</code>，它的意思是在能够执行<code>Fn</code>的第一时间去执行它，更通俗一点的说，如果有主线程中同步任务在执行，那么在同步任务执行结束时立刻将<code>Fn</code>调入主线程中执行，也就是说它同样也需要为同步任务让路。</p>
<h3 id="宏任务与微任务"><a href="#宏任务与微任务" class="headerlink" title="宏任务与微任务"></a>宏任务与微任务</h3><p>除了广义的同步任务与异步任务，我们对任务还有更精细的划分：</p>
<ul>
<li>宏任务（<code>macro-task</code>）：包括整体代码<code>Script</code>、<code>setTimeOut</code>、<code>setInterval</code></li>
<li>微任务（<code>micro-task</code>）：<code>Promise</code>的<code>then()</code>，<code>process.nextTick</code></li>
</ul>
<p><em><code>process.nextTick</code>类似node.js版的<code>setTimeOut</code></em></p>
<p>事件循环中宏任务与微任务的执行机制如下图所示：</p>
<p><img src="https://chenspace.oss-cn-shanghai.aliyuncs.com/uPic/%E5%AE%8F%E4%BB%BB%E5%8A%A1%E5%92%8C%E5%BE%AE%E4%BB%BB%E5%8A%A1.png" alt="宏任务和微任务"></p>
<p>首先整个代码片段会作为一个宏任务执行，执行过程中将具体的任务划分为宏任务与微任务，当整体执行后开始执行划分的所有微任务，所有微任务执行结束，开始执行下一个宏任务。下面看一段比较复杂的代码：</p>
<figure class="highlight js"><figcaption><span>点击展开代码 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;2&#x27;</span>);</span><br><span class="line">    process.nextTick(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;3&#x27;</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;4&#x27;</span>);</span><br><span class="line">        resolve();</span><br><span class="line">    &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">process.nextTick(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;6&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;7&#x27;</span>);</span><br><span class="line">    resolve();</span><br><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;8&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;9&#x27;</span>);</span><br><span class="line">    process.nextTick(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;10&#x27;</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;11&#x27;</span>);</span><br><span class="line">        resolve();</span><br><span class="line">    &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;12&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>第一轮事件循环流程分析：</strong></p>
<ol>
<li>整体代码作为一个宏任务进入主线程中开始执行，遇到<code>console.log(&#39;1&#39;)</code>直接输出<code>1</code>；</li>
<li>遇到<code>setTimeOut</code>划分为一个宏任务，我们把第一个宏任务记为<code>setTimeOut1</code>；</li>
<li>再往下执行，遇到<code>process.nextTick</code>，划分为一个微任务，记为<code>process1</code>；</li>
<li>遇到<code>Promise</code>直接输出7，<code>.then</code>发布到微任务<code>Event Queue</code>中，记为<code>then1</code>；</li>
<li>又遇到了<code>setTimeOut</code>，划分为第二个宏任务，记为<code>setTimeOut2</code>；</li>
</ol>
<p>到此为止第一轮事件循环结束，我们看一下宏任务<code>Event Queue</code>与微任务<code>Event Queue</code>的情况：</p>
<table>
<thead>
<tr>
<th align="center">宏任务Event Queue</th>
<th align="center">微任务Event Queue</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>setTimeOut1</code></td>
<td align="center"><code>process1</code></td>
</tr>
<tr>
<td align="center"><code>setTimeOut2</code></td>
<td align="center"><code>then1</code></td>
</tr>
</tbody></table>
<p>第一轮宏任务执行完毕，开始执行所有的微任务，依次分别输出<code>process1</code>和<code>then1</code>，输出6和8，第一轮的输出结果是1,7,6,8。</p>
<p><strong>第二轮事件循环流程分析：</strong></p>
<ol>
<li>主线程中开始执行下一个宏任务<code>setTimeOut1</code>；</li>
<li>遇到<code>console.log(&#39;2&#39;)</code>直接输出2；</li>
<li>遇到<code>process.nextTick</code>划分为微任务<code>process2</code>；</li>
<li>遇到<code>Promise</code>直接输出4，<code>.then</code>记为微任务<code>then2</code>；</li>
</ol>
<p>到此为止第一轮事件循环结束，我们看一下宏任务<code>Event Queue</code>与微任务<code>Event Queue</code>的情况：</p>
<table>
<thead>
<tr>
<th align="center">宏任务Event Queue</th>
<th align="center">微任务Event Queue</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>setTimeOut</code>2</td>
<td align="center"><code>process2</code></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><code>then2</code></td>
</tr>
</tbody></table>
<p>第二轮宏任务执行完毕，开始执行所有微任务，依次分别输出<code>process2</code>和<code>then2</code>，输出3和5，第二轮的输出结果是2,4,3,5。</p>
<p><strong>第三轮事件循环流程分析：</strong></p>
<ol>
<li>主线程开始执行最后一个宏任务<code>setTimeOut2</code>；</li>
<li>遇到 <code>console.log(&#39;9&#39;)</code>直接输出9；</li>
<li>遇到 <code>process.nextTick</code>记为微任务<code>process3</code>；</li>
<li>遇到<code>Promise</code>直接输出11，<code>.then</code>记为微任务<code>then3</code>；</li>
</ol>
<p>到此为止第三轮事件循环结束，我们看一下宏任务<code>Event Queue</code>与微任务<code>Event Queue</code>的情况：</p>
<table>
<thead>
<tr>
<th align="center">宏任务Event Queue</th>
<th align="center">微任务Event Queue</th>
</tr>
</thead>
<tbody><tr>
<td align="center"></td>
<td align="center"><code>process3</code></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><code>then3</code></td>
</tr>
</tbody></table>
<p>第三轮宏任务执行完毕，开始执行所有微任务，依次分别输出<code>process3</code>和<code>then3</code>，输出10和12，第二轮的输出结果是9,11,10,12。</p>
<p>到此为止，整段代码执行结束，最后的输出结果为：1,7,6,8,2,4,3,5,9,11,10,12。最后注意，<code>node</code>环境下的事件监听依赖<code>libuv</code>与前端环境不完全相同，输出顺序可能会有误差。</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Js引擎级别的执行</p><p><a href="https://pigpeq.github.io/2019/e7a52f913357/">https://pigpeq.github.io/2019/e7a52f913357/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>ChenL</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2019-06-03</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2022-01-29</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="" rel="noopener" target="_blank" title="CC BY 4.0" href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC BY 4.0</a></p></div></div></div></div></div><span class="article-tags is-size-7 last_update"><i class="fas fa-wrench">&nbsp;&nbsp;</i><time dateTime="2022-01-29T12:25:28.470Z" title="2022-01-29T12:25:28.470Z">2022-01-29</time>更新</span><div class="article-tags is-size-7 mb-4"><a class="link-muted mr-2" rel="tag" href="/tags/Js/">Js</a><a class="link-muted mr-2" rel="tag" href="/tags/v8/">v8</a></div><div class="sharethis-inline-share-buttons"></div><script src="https://cdn.jsdelivr.net/gh/pigPEQ/pigPEQ.github.io/js/sharethis.js#property=61e98b989343fb0019ed0b2a&amp;product=inline-share-buttons" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="https://cdn.jsdelivr.net/gh/pigPEQ/pigPEQ.github.io/img/Alipay-qrcode.jpg" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="https://cdn.jsdelivr.net/gh/pigPEQ/pigPEQ.github.io/img/Wechat-qrcode.jpg" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2019/250c39b7a1f4/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">魔改终端</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2019/2675e9671c97/"><span class="level-item">中华人民共和国网络安全法</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div class="content twikoo" id="twikoo"></div><script src="https://cdn.jsdelivr.net/npm/twikoo@1.4.15/dist/twikoo.all.min.js"></script><script>twikoo.init({
      envId: 'https://twikoo-pigpeq.vercel.app/',
      onCommentLoaded: function () {
        var commentContents = document.getElementsByClassName('tk-content');
        for (var i = 0; i < commentContents.length; i++) {
          var commentItem = commentContents[i];
          var imgEls = commentItem.getElementsByTagName('img');
          if (imgEls.length > 0) {
            for (var j = 0; j < imgEls.length; j++) {
              var imgEl = imgEls[j];
              var aEl = document.createElement('a');
              aEl.setAttribute('class', 'tk-lg-link');
              aEl.setAttribute('href', imgEl.getAttribute('src'));
              aEl.setAttribute('data-src', imgEl.getAttribute('src'));
              aEl.appendChild(imgEl.cloneNode(false));
              imgEl.parentNode.insertBefore(aEl, imgEl.nextSibling);
              imgEl.remove();
            }
            if (typeof $.fn.lightGallery === 'function') {
              $(commentItem).lightGallery({
                selector: '.tk-lg-link'
              });
            }
          }
        }
      }
    });</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://cdn.jsdelivr.net/gh/pigPEQ/pigPEQ.github.io/img/avatar.jpg" alt="ChenL"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">ChenL</p><p class="is-size-6 is-block">不念过去，不畏将来.</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Shanghai, China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">11</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">6</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">28</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/pigPEQ" target="_blank" rel="noopener"><i class="fab fa-github"></i>  Follow</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Weibo" href="https://weibo.com/u/5664924819"><i class="fab fa-weibo"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="QQ" href="tencent://message/?uin=1083341411&amp;Site=pigPEQ.github.io&amp;Menu=yes"><i class="fab fa-qq"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Mail" href="mailto:1083341411@qq.com"><i class="fas fa-envelope"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="https://cdn.jsdelivr.net/gh/pigPEQ/pigPEQ.github.io/atom.xml"><i class="fas fa-rss"></i></a></div><hr style="margin: 0"><div id="hitokoto-container"><span id="subtitle"></span></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#执行上下文"><span class="level-left"><span class="level-item">1</span><span class="level-item">执行上下文</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#上下文的分类"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">上下文的分类</span></span></a></li><li><a class="level is-mobile" href="#上下文的创建"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">上下文的创建</span></span></a></li></ul></li><li><a class="level is-mobile" href="#调用栈"><span class="level-left"><span class="level-item">2</span><span class="level-item">调用栈</span></span></a></li><li><a class="level is-mobile" href="#事件循环"><span class="level-left"><span class="level-item">3</span><span class="level-item">事件循环</span></span></a><ul class="menu-list"><ul class="menu-list"><li><a class="level is-mobile" href="#举例"><span class="level-left"><span class="level-item">3.1.1</span><span class="level-item">举例</span></span></a></li></ul></ul></li><li><a class="level is-mobile" href="#宏任务与微任务"><span class="level-left"><span class="level-item">4</span><span class="level-item">宏任务与微任务</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img class="logo-img" src="/img/logo-light.png" alt="MSpace" height="28"><img class="logo-img-dark" src="/img/logo-night.png" alt="MSpace" height="28"></a><p class="is-size-7"><span>&copy; 2021-2022 ChenL</span><span> Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></span><br><span>&copy; </span>「版权声明」：本站所有内容均为原创或收集于互联网,<br><span>   便于网友与自己学习交流，如有侵权，请<a href="/message" target="_blank" rel="noopener">留言</a>，立即处理</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Deployed on Vercel" href="https://vercel.com"><i class="fas fa-caret-square-up"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/twikoo@1.4.15/dist/twikoo.all.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/gh/pigPEQ/pigPEQ.github.io/js/column.min.js"></script><script src="https://cdn.jsdelivr.net/gh/pigPEQ/pigPEQ.github.io/js/animation.min.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="https://cdn.jsdelivr.net/gh/pigPEQ/pigPEQ.github.io/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/gh/pigPEQ/pigPEQ.github.io/js/main.min.js"></script><script src="https://cdn.jsdelivr.net/gh/pigPEQ/pigPEQ.github.io/js/friend.min.js"></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script src="https://unpkg.com/typewriter-effect@latest/dist/core.js"></script><script src="https://cdn.jsdelivr.net/npm/bluebird@3/js/browser/bluebird.min.js"></script><script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@2.0.3/fetch.min.js"></script><script src="https://cdn.jsdelivr.net/gh/pigPEQ/pigPEQ.github.io/js/universe.min.js"></script><script src="https://cdn.jsdelivr.net/gh/pigPEQ/pigPEQ.github.io/js/subtitleType.min.js"></script><script src="https://cdn.jsdelivr.net/gh/pigPEQ/pigPEQ.github.io/js/custom.min.js"></script></body></html>